# Search-R1 + Qwen3-0.6b éƒ¨ç½²æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Search-R1 é¡¹ç›®éƒ¨ç½²æ–¹æ¡ˆï¼Œé…ç½®ä¸ºä½¿ç”¨ Qwen3-0.6b æ¨¡å‹è¿›è¡Œæ·±åº¦ç ”ç©¶ï¼ˆDeepResearchï¼‰è®­ç»ƒã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

**Search-R1** æ˜¯ä¸€ä¸ªå¼€æºçš„å¼ºåŒ–å­¦ä¹ æ¡†æ¶ï¼Œç”¨äºè®­ç»ƒè¯­è¨€æ¨¡å‹åŒæ—¶è¿›è¡Œæ¨ç†å’Œæœç´¢å¼•æ“è°ƒç”¨ã€‚æœ¬éƒ¨ç½²æ–¹æ¡ˆï¼š

- âœ… ä½¿ç”¨ **Qwen3-0.6b** æ¨¡å‹ï¼ˆè½»é‡çº§ï¼Œé€‚åˆå¿«é€Ÿå®éªŒï¼‰
- âœ… åŒ…å«å®Œæ•´çš„ç¤ºä¾‹æ•°æ®é›†å’Œè¯­æ–™åº“
- âœ… æä¾› **BM25 ç¨€ç–æ£€ç´¢**æœåŠ¡å™¨
- âœ… ä½¿ç”¨ **GRPO** ç®—æ³•è¿›è¡Œå¼ºåŒ–å­¦ä¹ è®­ç»ƒ
- âœ… **ä¸€é”®å¯åŠ¨**æ‰€æœ‰æœåŠ¡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 20.04/22.04 æ¨è)
- **GPU**: NVIDIA GPU with CUDA 12.1+ (æ¨èè‡³å°‘ 12GB VRAM)
- **Python**: 3.9
- **ç£ç›˜ç©ºé—´**: è‡³å°‘ 20GB

### ä¸€é”®å®‰è£…ä¸è¿è¡Œ

```bash
# 1. è¿è¡Œå®‰è£…è„šæœ¬
./install.sh

# 2. æ¿€æ´»ç¯å¢ƒï¼ˆå¦‚æœä½¿ç”¨ venvï¼‰
source venv/bin/activate

# æˆ–è€…æ¿€æ´» conda ç¯å¢ƒ
conda activate searchr1

# 3. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡å’Œè®­ç»ƒ
./run.sh
```

å°±è¿™ä¹ˆç®€å•ï¼`run.sh` ä¼šè‡ªåŠ¨ï¼š
1. âœ… æ£€æŸ¥ç¯å¢ƒå’Œä¾èµ–
2. âœ… å¯åŠ¨æ£€ç´¢æœåŠ¡å™¨
3. âœ… ç­‰å¾…æœåŠ¡å™¨å°±ç»ª
4. âœ… å¼€å§‹ RL è®­ç»ƒ

## ğŸ“ é¡¹ç›®ç»“æ„

```
search-r1-deployment/
â”œâ”€â”€ Search-R1/              # Search-R1 æºä»£ç 
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ sample_corpus.jsonl     # ç¤ºä¾‹è¯­æ–™åº“ï¼ˆ10ä¸ªæ–‡æ¡£ï¼‰
â”‚   â””â”€â”€ sample_train.jsonl      # ç¤ºä¾‹è®­ç»ƒæ•°æ®ï¼ˆ10ä¸ªé—®é¢˜ï¼‰
â”œâ”€â”€ models/                 # æ¨¡å‹ç›®å½•ï¼ˆå¯é€‰ï¼Œç”¨äºæœ¬åœ°æ¨¡å‹ï¼‰
â”œâ”€â”€ indexes/                # æ£€ç´¢ç´¢å¼•
â”œâ”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ checkpoints/            # è®­ç»ƒæ£€æŸ¥ç‚¹
â”œâ”€â”€ install.sh              # å®‰è£…è„šæœ¬
â”œâ”€â”€ start_retriever.sh      # å¯åŠ¨æ£€ç´¢æœåŠ¡å™¨
â”œâ”€â”€ train_qwen3_0.6b.sh     # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ run.sh                  # ä¸€é”®å¯åŠ¨è„šæœ¬
â””â”€â”€ README.md               # æœ¬æ–‡ä»¶
```

## ğŸ”§ è¯¦ç»†ä½¿ç”¨è¯´æ˜

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

è¿è¡Œå®‰è£…è„šæœ¬ï¼š

```bash
./install.sh
```

è¿™ä¼šå®‰è£…ï¼š
- PyTorch 2.4.0 (CUDA 12.1)
- vLLM 0.6.3
- Flash Attention 2
- veRL æ¡†æ¶
- å…¶ä»–ä¾èµ–

### æ­¥éª¤ 2: é…ç½®æ¨¡å‹

é»˜è®¤é…ç½®ä¼šè‡ªåŠ¨ä» HuggingFace ä¸‹è½½ `Qwen/Qwen3-0.6B` æ¨¡å‹ã€‚

**ä½¿ç”¨æœ¬åœ°æ¨¡å‹**ï¼ˆå¯é€‰ï¼‰ï¼š

1. ä¸‹è½½æ¨¡å‹åˆ° `models/` ç›®å½•
2. ç¼–è¾‘ `train_qwen3_0.6b.sh`ï¼Œä¿®æ”¹ï¼š
   ```bash
   export BASE_MODEL='../models/Qwen3-0.6B'
   ```

### æ­¥éª¤ 3: å‡†å¤‡æ•°æ®

æœ¬é¡¹ç›®å·²åŒ…å«ç¤ºä¾‹æ•°æ®ï¼š

**è¯­æ–™åº“æ ¼å¼** (`data/sample_corpus.jsonl`):
```json
{"id": "doc1", "contents": "æ–‡æ¡£å†…å®¹..."}
{"id": "doc2", "contents": "æ–‡æ¡£å†…å®¹..."}
```

**è®­ç»ƒæ•°æ®æ ¼å¼** (`data/sample_train.jsonl`):
```json
{"data_source": "sample", "prompt": "é—®é¢˜", "ability": "search", "reward_model": "exact_match"}
```

**ä½¿ç”¨è‡ªå·±çš„æ•°æ®**ï¼š
1. å‡†å¤‡ç¬¦åˆä¸Šè¿°æ ¼å¼çš„ JSONL æ–‡ä»¶
2. æ”¾å…¥ `data/` ç›®å½•
3. ä¿®æ”¹ `train_qwen3_0.6b.sh` ä¸­çš„æ•°æ®è·¯å¾„

### æ­¥éª¤ 4: å¯åŠ¨æœåŠ¡

#### æ–¹å¼ 1: ä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
./run.sh
```

#### æ–¹å¼ 2: åˆ†æ­¥å¯åŠ¨

```bash
# 1. å¯åŠ¨æ£€ç´¢æœåŠ¡å™¨
./start_retriever.sh

# 2. å¯åŠ¨è®­ç»ƒï¼ˆæ–°ç»ˆç«¯ï¼‰
./train_qwen3_0.6b.sh
```

### æ­¥éª¤ 5: ç›‘æ§è®­ç»ƒ

**æŸ¥çœ‹å®æ—¶æ—¥å¿—**ï¼š
```bash
tail -f logs/training.log
```

**æŸ¥çœ‹æ£€ç´¢æœåŠ¡å™¨æ—¥å¿—**ï¼š
```bash
tail -f logs/retriever.log
```

**æ£€æŸ¥ GPU ä½¿ç”¨æƒ…å†µ**ï¼š
```bash
watch -n 1 nvidia-smi
```

## ğŸ“Š è®­ç»ƒé…ç½®è¯¦è§£

### Qwen3-0.6b ä¼˜åŒ–å‚æ•°

æœ¬éƒ¨ç½²é’ˆå¯¹ 0.6B å°æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–ï¼š

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `train_batch_size` | 32 | è®­ç»ƒæ‰¹æ¬¡å¤§å°ï¼ˆé’ˆå¯¹å°æ¨¡å‹ä¼˜åŒ–ï¼‰|
| `ppo_mini_batch_size` | 16 | PPO å°æ‰¹æ¬¡å¤§å° |
| `ppo_micro_batch_size` | 4 | å¾®æ‰¹æ¬¡å¤§å° |
| `max_prompt_length` | 2048 | æœ€å¤§æç¤ºé•¿åº¦ |
| `max_response_length` | 256 | æœ€å¤§å“åº”é•¿åº¦ |
| `learning_rate` | 5e-6 | å­¦ä¹ ç‡ |
| `gpu_memory_utilization` | 0.5 | GPU å†…å­˜ä½¿ç”¨ç‡ |
| `total_training_steps` | 100 | æ€»è®­ç»ƒæ­¥æ•°ï¼ˆç¤ºä¾‹ï¼‰ |

### ç®—æ³•é€‰æ‹©

- **GRPO** (Group Relative Policy Optimization): é€‚åˆå°æ¨¡å‹ï¼Œå†…å­˜æ•ˆç‡é«˜
- **PPO**: å¯é€‰ï¼Œé€‚åˆå¤§æ¨¡å‹

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: è®­ç»ƒæ—¶ GPU å†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å‡å° `train_batch_size` å’Œ `ppo_mini_batch_size`
2. å‡å° `max_prompt_length` å’Œ `max_response_length`
3. å¯ç”¨ offload:
   ```bash
   actor_rollout_ref.actor.fsdp_config.param_offload=true
   actor_rollout_ref.actor.fsdp_config.grad_offload=true
   ```

### Q2: æ£€ç´¢æœåŠ¡å™¨æ— æ³•å¯åŠ¨ï¼Ÿ

**æ£€æŸ¥**ï¼š
1. ç«¯å£ 8000 æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :8000`
2. Python ç¯å¢ƒæ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—ï¼š`cat logs/retriever.log`

### Q3: å¦‚ä½•ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼Ÿ

**æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `train_qwen3_0.6b.sh` ä¸­çš„ `BASE_MODEL`
2. å¢åŠ  `train_batch_size` å’Œå†…å­˜ç›¸å…³å‚æ•°
3. è€ƒè™‘ä½¿ç”¨å¤š GPUï¼šè®¾ç½® `CUDA_VISIBLE_DEVICES=0,1,2,3`

### Q4: å¦‚ä½•ä½¿ç”¨åœ¨çº¿æœç´¢ API è€Œä¸æ˜¯æœ¬åœ°æ£€ç´¢ï¼Ÿ

**ä¿®æ”¹ `start_retriever.sh`**ï¼š

ä½¿ç”¨ Google Search API:
```bash
python3 search_r1/search/retrieval_server_api.py \
    --api_type google \
    --api_key YOUR_API_KEY
```

### Q5: è®­ç»ƒå®Œæˆåå¦‚ä½•ä½¿ç”¨æ¨¡å‹ï¼Ÿ

**æ¨ç†**ï¼š
```bash
cd Search-R1
python3 infer.py \
    --model_path ../checkpoints/search-r1-qwen3-0.6b-demo/final \
    --prompt "ä½ çš„é—®é¢˜"
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®ä¼˜åŒ–
- ä½¿ç”¨æ›´å¤§ã€æ›´é«˜è´¨é‡çš„è¯­æ–™åº“
- å¢åŠ è®­ç»ƒæ•°æ®å¤šæ ·æ€§
- ä½¿ç”¨ç›¸å…³é¢†åŸŸçš„ä¸“ä¸šæ•°æ®

### 2. æ¨¡å‹ä¼˜åŒ–
- å°è¯•ä¸åŒå¤§å°çš„ Qwen æ¨¡å‹ï¼ˆ1.5Bã€3Bã€7Bï¼‰
- è°ƒæ•´æ¸©åº¦å‚æ•°æ§åˆ¶ç”Ÿæˆå¤šæ ·æ€§
- å®éªŒä¸åŒçš„å­¦ä¹ ç‡

### 3. æ£€ç´¢ä¼˜åŒ–
- ä½¿ç”¨å¯†é›†æ£€ç´¢ï¼ˆDense Retrievalï¼‰æé«˜å‡†ç¡®æ€§
- å¢åŠ æ£€ç´¢æ–‡æ¡£æ•°é‡ï¼ˆtopkï¼‰
- ä½¿ç”¨é‡æ’åºï¼ˆRerankerï¼‰

### 4. è®­ç»ƒä¼˜åŒ–
- ä½¿ç”¨å¤š GPU å¹¶è¡Œè®­ç»ƒ
- è°ƒæ•´ PPO è¶…å‚æ•°ï¼ˆKL æ•£åº¦ç³»æ•°ç­‰ï¼‰
- å¢åŠ è®­ç»ƒæ­¥æ•°å’Œ epoch

## ğŸ”„ é«˜çº§é…ç½®

### ä½¿ç”¨å¤š GPU è®­ç»ƒ

ç¼–è¾‘ `train_qwen3_0.6b.sh`:
```bash
export CUDA_VISIBLE_DEVICES=0,1,2,3
trainer.n_gpus_per_node=4
```

### ä½¿ç”¨å¯†é›†æ£€ç´¢ï¼ˆDense Retrievalï¼‰

éœ€è¦é¢å¤–çš„ retriever ç¯å¢ƒï¼š
```bash
conda create -n retriever python=3.10
conda activate retriever
conda install pytorch faiss-gpu -c pytorch
pip install transformers pyserini uvicorn fastapi
```

### è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹

ä¿®æ”¹è®­ç»ƒæ•°æ®ä¸­çš„ `reward_model` å­—æ®µï¼Œæ”¯æŒï¼š
- `exact_match`: ç²¾ç¡®åŒ¹é…
- `f1_score`: F1 åˆ†æ•°
- è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°

## ğŸ“š å‚è€ƒèµ„æº

- **Search-R1 è®ºæ–‡**: [Paper1](https://arxiv.org/abs/2503.09516), [Paper2](https://arxiv.org/abs/2505.15117)
- **HuggingFace èµ„æº**: [Search-R1 Collection](https://huggingface.co/collections/PeterJinGo/search-r1-67d1a021202731cb065740f5)
- **åŸå§‹ä»“åº“**: [GitHub](https://github.com/PeterGriffinJin/Search-R1)
- **veRL æ¡†æ¶**: [GitHub](https://github.com/volcengine/verl)
- **Qwen æ¨¡å‹**: [HuggingFace](https://huggingface.co/Qwen)

## ğŸ¤ è´¡çŒ®ä¸æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹ `logs/` ç›®å½•ä¸­çš„æ—¥å¿—æ–‡ä»¶
2. æ£€æŸ¥ [Search-R1 Issues](https://github.com/PeterGriffinJin/Search-R1/issues)
3. å‚è€ƒ Search-R1 å®˜æ–¹æ–‡æ¡£

## ğŸ“ è®¸å¯è¯

æœ¬éƒ¨ç½²æ–¹æ¡ˆéµå¾ª Apache 2.0 è®¸å¯è¯ï¼ˆä¸ Search-R1 é¡¹ç›®ä¸€è‡´ï¼‰ã€‚

## ğŸ¯ åç»­æ­¥éª¤

å®ŒæˆåŸºç¡€è®­ç»ƒåï¼Œæ‚¨å¯ä»¥ï¼š

1. **è¯„ä¼°æ¨¡å‹æ€§èƒ½**ï¼šä½¿ç”¨æµ‹è¯•é›†è¯„ä¼°
2. **å¾®è°ƒè¶…å‚æ•°**ï¼šè°ƒæ•´å­¦ä¹ ç‡ã€æ‰¹æ¬¡å¤§å°ç­‰
3. **æ‰©å±•æ•°æ®é›†**ï¼šä½¿ç”¨é¢†åŸŸç‰¹å®šæ•°æ®
4. **éƒ¨ç½²åº”ç”¨**ï¼šå°†è®­ç»ƒå¥½çš„æ¨¡å‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
5. **å®éªŒä¸åŒé…ç½®**ï¼šå°è¯•ä¸åŒæ¨¡å‹ã€æ£€ç´¢æ–¹æ³•ã€RL ç®—æ³•

---

**ç¥è®­ç»ƒé¡ºåˆ©ï¼** ğŸš€
